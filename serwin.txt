#!/bin/bash

# بررسی ورودی
if [ -z "$1" ]; then
  echo "❌ لطفاً لینک سرور را وارد کنید!"
  echo "✅ مثال:"
  echo "./convert.sh 'vless://UUID@server:port?security=none&type=grpc&serviceName=service'"
  exit 1
fi

# دریافت لینک از ورودی
LINK=$1

# بررسی نوع لینک
if [[ $LINK == vless://* ]]; then
  TYPE="vless"
  UUID=$(echo $LINK | sed -n 's#vless://\([^@]*\)@.*#\1#p')
  SERVER=$(echo $LINK | sed -n 's#vless://[^@]*@\([^:]*\):.*#\1#p')
  PORT=$(echo $LINK | sed -n 's#vless://[^@]*@[^:]*:\([^?]*\)?.*#\1#p')
  STREAM_TYPE=$(echo $LINK | sed -n 's#.*type=\([^&]*\).*#\1#p')
  SERVICE_NAME=$(echo $LINK | sed -n 's#.*serviceName=\([^&]*\).*#\1#p')
  
  STREAM_SETTINGS="{
        \"network\": \"$STREAM_TYPE\",
        \"security\": \"none\""

  if [ "$STREAM_TYPE" == "grpc" ]; then
    STREAM_SETTINGS+=", \"grpcSettings\": { \"serviceName\": \"$SERVICE_NAME\" }"
  fi

  STREAM_SETTINGS+=" }"

elif [[ $LINK == vmess://* ]]; then
  TYPE="vmess"
  VMESS_JSON=$(echo $LINK | sed 's#vmess://##' | base64 -d 2>/dev/null)
  UUID=$(echo $VMESS_JSON | jq -r .id)
  SERVER=$(echo $VMESS_JSON | jq -r .add)
  PORT=$(echo $VMESS_JSON | jq -r .port)
  STREAM_TYPE=$(echo $VMESS_JSON | jq -r .net)

  STREAM_SETTINGS="{
        \"network\": \"$STREAM_TYPE\",
        \"security\": \"none\"
  }"

elif [[ $LINK == ss://* ]]; then
  TYPE="shadowsocks"
  SS_INFO=$(echo $LINK | sed 's#ss://##' | base64 -d 2>/dev/null)
  METHOD=$(echo $SS_INFO | awk -F ':' '{print $1}')
  PASSWORD=$(echo $SS_INFO | awk -F '@' '{print $1}' | cut -d ':' -f2)
  SERVER=$(echo $SS_INFO | awk -F '@' '{print $2}' | awk -F ':' '{print $1}')
  PORT=$(echo $SS_INFO | awk -F ':' '{print $3}')

  STREAM_SETTINGS="{
        \"network\": \"tcp\",
        \"security\": \"none\"
  }"

elif [[ $LINK == trojan://* ]]; then
  TYPE="trojan"
  PASSWORD=$(echo $LINK | sed -n 's#trojan://\([^@]*\)@.*#\1#p')
  SERVER=$(echo $LINK | sed -n 's#trojan://[^@]*@\([^:]*\):.*#\1#p')
  PORT=$(echo $LINK | sed -n 's#trojan://[^@]*@[^:]*:\([^?]*\)?.*#\1#p')

  STREAM_SETTINGS="{
        \"network\": \"tcp\",
        \"security\": \"tls\"
  }"

else
  echo "❌ فرمت لینک پشتیبانی نمی‌شود!"
  exit 1
fi

# تولید فایل JSON
cat > config.json <<EOF
{
  "inbounds": [
    {
      "port": 10808,
      "protocol": "socks",
      "settings": {
        "auth": "noauth",
        "udp": true
      }
    },
    {
      "port": 10809,
      "protocol": "http",
      "settings": {
        "allowTransparent": false
      }
    }
  ],
  "outbounds": [
    {
      "protocol": "$TYPE",
      "settings": {
        "vnext": [
          {
            "address": "$SERVER",
            "port": $PORT,
            "users": [
              {
                "id": "$UUID",
                "password": "$PASSWORD",
                "method": "$METHOD",
                "encryption": "none"
              }
            ]
          }
        ]
      },
      "streamSettings": $STREAM_SETTINGS
    }
  ]
}
EOF

echo "✅ فایل config.json ساخته شد!"

# اجرای Xray
echo "🚀 اجرای Xray..."
xray -c config.json
