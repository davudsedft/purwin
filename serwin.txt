#!/bin/bash

# Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ±ÙˆØ¯ÛŒ
if [ -z "$1" ]; then
  echo "âŒ Ù„Ø·ÙØ§Ù‹ Ù„ÛŒÙ†Ú© Ø³Ø±ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯!"
  echo "âœ… Ù…Ø«Ø§Ù„:"
  echo "./convert.sh 'vless://UUID@server:port?security=none&type=grpc&serviceName=service'"
  exit 1
fi

# Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒÙ†Ú© Ø§Ø² ÙˆØ±ÙˆØ¯ÛŒ
LINK=$1

# Ø¨Ø±Ø±Ø³ÛŒ Ù†ÙˆØ¹ Ù„ÛŒÙ†Ú©
if [[ $LINK == vless://* ]]; then
  TYPE="vless"
  UUID=$(echo $LINK | sed -n 's#vless://\([^@]*\)@.*#\1#p')
  SERVER=$(echo $LINK | sed -n 's#vless://[^@]*@\([^:]*\):.*#\1#p')
  PORT=$(echo $LINK | sed -n 's#vless://[^@]*@[^:]*:\([^?]*\)?.*#\1#p')
  STREAM_TYPE=$(echo $LINK | sed -n 's#.*type=\([^&]*\).*#\1#p')
  SERVICE_NAME=$(echo $LINK | sed -n 's#.*serviceName=\([^&]*\).*#\1#p')
  
  STREAM_SETTINGS="{
        \"network\": \"$STREAM_TYPE\",
        \"security\": \"none\""

  if [ "$STREAM_TYPE" == "grpc" ]; then
    STREAM_SETTINGS+=", \"grpcSettings\": { \"serviceName\": \"$SERVICE_NAME\" }"
  fi

  STREAM_SETTINGS+=" }"

elif [[ $LINK == vmess://* ]]; then
  TYPE="vmess"
  VMESS_JSON=$(echo $LINK | sed 's#vmess://##' | base64 -d 2>/dev/null)
  UUID=$(echo $VMESS_JSON | jq -r .id)
  SERVER=$(echo $VMESS_JSON | jq -r .add)
  PORT=$(echo $VMESS_JSON | jq -r .port)
  STREAM_TYPE=$(echo $VMESS_JSON | jq -r .net)

  STREAM_SETTINGS="{
        \"network\": \"$STREAM_TYPE\",
        \"security\": \"none\"
  }"

elif [[ $LINK == ss://* ]]; then
  TYPE="shadowsocks"
  SS_INFO=$(echo $LINK | sed 's#ss://##' | base64 -d 2>/dev/null)
  METHOD=$(echo $SS_INFO | awk -F ':' '{print $1}')
  PASSWORD=$(echo $SS_INFO | awk -F '@' '{print $1}' | cut -d ':' -f2)
  SERVER=$(echo $SS_INFO | awk -F '@' '{print $2}' | awk -F ':' '{print $1}')
  PORT=$(echo $SS_INFO | awk -F ':' '{print $3}')

  STREAM_SETTINGS="{
        \"network\": \"tcp\",
        \"security\": \"none\"
  }"

elif [[ $LINK == trojan://* ]]; then
  TYPE="trojan"
  PASSWORD=$(echo $LINK | sed -n 's#trojan://\([^@]*\)@.*#\1#p')
  SERVER=$(echo $LINK | sed -n 's#trojan://[^@]*@\([^:]*\):.*#\1#p')
  PORT=$(echo $LINK | sed -n 's#trojan://[^@]*@[^:]*:\([^?]*\)?.*#\1#p')

  STREAM_SETTINGS="{
        \"network\": \"tcp\",
        \"security\": \"tls\"
  }"

else
  echo "âŒ ÙØ±Ù…Øª Ù„ÛŒÙ†Ú© Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯!"
  exit 1
fi

# ØªÙˆÙ„ÛŒØ¯ ÙØ§ÛŒÙ„ JSON
cat > config.json <<EOF
{
  "inbounds": [
    {
      "port": 10808,
      "protocol": "socks",
      "settings": {
        "auth": "noauth",
        "udp": true
      }
    },
    {
      "port": 10809,
      "protocol": "http",
      "settings": {
        "allowTransparent": false
      }
    }
  ],
  "outbounds": [
    {
      "protocol": "$TYPE",
      "settings": {
        "vnext": [
          {
            "address": "$SERVER",
            "port": $PORT,
            "users": [
              {
                "id": "$UUID",
                "password": "$PASSWORD",
                "method": "$METHOD",
                "encryption": "none"
              }
            ]
          }
        ]
      },
      "streamSettings": $STREAM_SETTINGS
    }
  ]
}
EOF

echo "âœ… ÙØ§ÛŒÙ„ config.json Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯!"

# Ø§Ø¬Ø±Ø§ÛŒ Xray
echo "ðŸš€ Ø§Ø¬Ø±Ø§ÛŒ Xray..."
xray -c config.json
