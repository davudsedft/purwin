#!/bin/bash

echo "📦 در حال نصب PurWin GUI ..."

# نصب پیش‌نیازها
echo "🐍 نصب پکیج‌های پایتون..."
pip3 install --break-system-packages customtkinter psutil Pillow

# ساخت مسیر نصب
sudo mkdir -p /opt/purwin
sudo cp main.py purwint icon.png /opt/purwin/
sudo chmod +x /opt/purwin/main.py /opt/purwin/purwint

# ساخت فایل policykit برای pkexec
echo "🔐 در حال ساخت PolicyKit..."
sudo tee /usr/share/polkit-1/actions/com.purwin.gui.policy > /dev/null <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<policyconfig>
  <action id="com.purwin.gui">
    <description>Run PurWin GUI as root</description>
    <message>Authentication is required to run PurWin GUI</message>
    <defaults>
      <allow_any>auth_admin</allow_any>
      <allow_inactive>auth_admin</allow_inactive>
      <allow_active>auth_admin</allow_active>
    </defaults>
    <annotate key="org.freedesktop.policykit.exec.path">/usr/bin/python3</annotate>
    <annotate key="org.freedesktop.policykit.exec.argv1">/opt/purwin/main.py</annotate>
  </action>
</policyconfig>
EOF

# ساخت فایل desktop
echo "🖥️ در حال ساخت شورتکات دسکتاپ..."
tee ~/.local/share/applications/purwin.desktop > /dev/null <<EOF
[Desktop Entry]
Name=PurWin GUI
Exec=pkexec python3 /opt/purwin/main.py
Icon=/opt/purwin/icon.png
Terminal=false
Type=Application
Categories=Utility;
EOF

chmod +x ~/.local/share/applications/purwin.desktop

# کپی روی دسکتاپ
cp ~/.local/share/applications/purwin.desktop ~/Desktop/
chmod +x ~/Desktop/purwin.desktop

echo "✅ نصب با موفقیت انجام شد. آیکون روی دسکتاپ ایجاد شد."
